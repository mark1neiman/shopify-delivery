{% assign last_address = customer.last_order.shipping_address | default: customer.default_address %}

<div
  class="pickup-card"
  data-itella-pickup-root="1"
  data-default-country="{{ localization.country.iso_code }}"
  data-label-country="{{ 'pickup.labels.country' | t }}"
  data-label-provider="{{ 'pickup.labels.provider' | t }}"
  data-label-pickup-point="{{ 'pickup.labels.pickup_point' | t }}"
  data-text-loading="{{ 'pickup.text.loading' | t }}"
  data-text-select-pickup="{{ 'pickup.text.select_pickup' | t }}"
  data-text-pickup-not-required="{{ 'pickup.text.pickup_not_required' | t }}"
  data-text-no-providers="{{ 'pickup.text.no_providers' | t }}"
  data-text-no-points="{{ 'pickup.text.no_points' | t }}"
  data-text-selected="{{ 'pickup.text.selected' | t }}"
  data-text-price-label="{{ 'pickup.text.price_label' | t }}"
  data-text-search-placeholder="{{ 'pickup.text.search_placeholder' | t }}"
  data-text-fallback="{{ 'pickup.text.fallback_notice' | t }}"
  data-customer-logged-in="{% if customer %}true{% else %}false{% endif %}"
  data-customer-email="{{ customer.email | escape }}"
  data-customer-name="{{ last_address.name | escape }}"
  data-customer-address1="{{ last_address.address1 | escape }}"
  data-customer-city="{{ last_address.city | escape }}"
  data-customer-zip="{{ last_address.zip | escape }}"
  data-customer-phone="{{ last_address.phone | escape }}"
  data-customer-phone-code=""
>
  <div class="pickup-fallback" id="pickup-fallback" hidden></div>

  <div class="pickup-section">
    <div class="pickup-title">{{ 'pickup.labels.country' | t }}</div>
    <button class="pickup-select" id="pickup-country-btn" type="button">
      <span class="pickup-flag" id="pickup-country-flag"></span>
      <span id="pickup-country-label">{{ 'pickup.text.loading' | t }}</span>
      <span class="pickup-chevron">▾</span>
    </button>
    <div class="pickup-menu" id="pickup-country-menu" hidden></div>
  </div>

  <div class="pickup-section">
    <div class="pickup-title">{{ 'pickup.labels.provider' | t }}</div>
    <div id="pickup-providers" class="pickup-providers"></div>

    <div class="pickup-points" id="pickup-points">
      <div class="pickup-points-title">{{ 'pickup.labels.pickup_point' | t }}</div>
      <button class="pickup-select" id="pickup-point-btn" type="button">
        <span id="pickup-point-label">{{ 'pickup.text.select_pickup' | t }}</span>
        <span class="pickup-chevron">▾</span>
      </button>

      <div class="pickup-menu pickup-points-menu" id="pickup-point-menu" hidden>
        <div class="pickup-menu-search">
          <input
            id="pickup-search"
            class="pickup-input"
            type="text"
            placeholder="{{ 'pickup.text.search_placeholder' | t }}"
          />
        </div>
        <div id="pickup-point-list" class="pickup-point-list"></div>
      </div>
    </div>

    <div id="pickup-current" class="pickup-current"></div>
  </div>

  <div class="pickup-section">
    <div class="pickup-title">Recipient details</div>

    <div class="pickup-field">
      <label for="pickup-name">Full name</label>
      <input id="pickup-name" class="pickup-input" type="text" placeholder="Name" />
    </div>

    <div class="pickup-field">
      <label for="pickup-address1">Address</label>
      <input id="pickup-address1" class="pickup-input" type="text" placeholder="Street and house" />
    </div>

    <div class="pickup-field-row">
      <div class="pickup-field">
        <label for="pickup-city">City</label>
        <input id="pickup-city" class="pickup-input" type="text" placeholder="City" />
      </div>
      <div class="pickup-field">
        <label for="pickup-zip">Postal code</label>
        <input id="pickup-zip" class="pickup-input" type="text" placeholder="Postal code" />
      </div>
    </div>

    <!-- Phone code + phone -->
    <div class="pickup-field-row">
      <div class="pickup-field">
        <label for="pickup-phone-code">Phone code</label>
        <select id="pickup-phone-code" class="pickup-input">
          <option value="+372">+372 (EE)</option>
          <option value="+371">+371 (LV)</option>
          <option value="+370">+370 (LT)</option>
          <option value="+358">+358 (FI)</option>
        </select>
      </div>

      <div class="pickup-field">
        <label for="pickup-phone">Phone</label>
        <input id="pickup-phone" class="pickup-input" type="text" placeholder="Phone" />
      </div>
    </div>

    <!-- Email: показываем всегда -->
    <div class="pickup-field">
      <label for="pickup-email">Email</label>
      <input id="pickup-email" class="pickup-input" type="email" placeholder="Email" />
      {% if customer %}
        <div style="font-size:12px;opacity:.65;margin-top:2px">
          We prefilled your account email — you can change it if needed.
        </div>
      {% endif %}
    </div>
  </div>

  <div class="pickup-section pickup-wolt" id="pickup-wolt" hidden>
    <div class="pickup-title">Wolt delivery time</div>
    <div class="pickup-wolt-notice" id="pickup-wolt-notice" hidden></div>
    <div class="pickup-field">
      <label for="pickup-wolt-date">Delivery date</label>
      <input id="pickup-wolt-date" class="pickup-input" type="date" />
    </div>
    <div class="pickup-field">
      <label for="pickup-wolt-time">Delivery time</label>
      <select id="pickup-wolt-time" class="pickup-input"></select>
    </div>
  </div>

  <div class="pickup-section">
    <button
      class="pickup-select"
      data-itella-checkout-btn
      type="button"
      style="justify-content:center !important;font-weight:700;"
    >
      Checkout
    </button>
    <div style="font-size:12px;opacity:.7">
      You will be redirected to the invoice checkout.
    </div>
  </div>
</div>

<style>
  .pickup-card{
    border:1px solid rgba(0,0,0,.12);
    border-radius:18px;
    padding:16px;
    background:#fff;
    max-width:520px;
  }
  .pickup-fallback{
    margin-bottom:10px;
    border:1px solid rgba(251,191,36,.4);
    background:rgba(251,191,36,.16);
    color:#92400e;
    border-radius:12px;
    padding:10px 12px;
    font-size:13px;
    font-weight:600;
  }
  .pickup-section{
    padding:12px;
    background:#f3f4f6;
    border-radius:14px;
    margin-top:14px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .pickup-title{font-weight:600;margin-bottom:2px}
  .pickup-select{
    width:100%;
    display:flex;
    align-items:center;
    gap:10px;
    padding:12px;
    border-radius:12px;
    border:1px solid rgba(0,0,0,.14);
    background:#fff;
    justify-content:flex-start !important;
    text-align:left !important;
    cursor:pointer;
  }
  #pickup-country-label,
  #pickup-point-label{
    flex:1;
    text-align:left !important;
  }
  .pickup-flag{
    width:22px;height:14px;border-radius:3px;
    background:#ddd;display:inline-block;
    background-size:cover;
    background-position:center;
  }
  .pickup-chevron{opacity:.7;margin-left:auto}
  .pickup-menu{
    margin-top:8px;
    background:#fff;
    border:1px solid rgba(0,0,0,.12);
    border-radius:12px;
    overflow:hidden;
    box-shadow:0 10px 20px rgba(0,0,0,.08);
  }
  .pickup-menu button{
    width:100%;
    padding:10px 12px;
    display:flex;
    gap:10px;
    align-items:center;
    background:#fff;
    border:0;
    text-align:left !important;
    justify-content:flex-start !important;
    cursor:pointer;
  }
  .pickup-menu-search{
    padding:10px 12px;
    border-bottom:1px solid rgba(0,0,0,.08);
  }
  .pickup-providers{display:flex;flex-direction:column;gap:10px}
  .pickup-provider{
    display:flex;align-items:flex-start;gap:10px;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid rgba(0,0,0,.14);
    background:#fff;
    cursor:pointer;
  }
  .pickup-provider input{accent-color:#111;margin:2px 0 0 0}
  .pickup-provider img{width:84px;height:auto;margin-top:2px}
  .pickup-provider.is-disabled{opacity:.45;cursor:not-allowed}
  .pickup-provider.is-disabled input{cursor:not-allowed}
  .pickup-provider-note{font-size:12px;color:#6b7280;margin-left:auto}
  .pickup-points{display:flex;flex-direction:column;gap:8px;position:relative}
  .pickup-points-title{font-weight:600;font-size:14px}
  .pickup-points-menu{
    max-height:280px;
    overflow:auto;
    position:absolute;
    left:0;
    right:0;
    top:100%;
    z-index:20;
  }
  .pickup-point-list{display:flex;flex-direction:column}
  .pickup-point-option{
    width:100%;
    border:0;
    background:#fff;
    text-align:left !important;
    justify-content:flex-start !important;
    padding:10px 12px;
    cursor:pointer;
  }
  .pickup-point-option:hover{background:#f3f4f6}
  .pickup-input{
    width:100%;
    padding:12px;
    border-radius:12px;
    border:1px solid rgba(0,0,0,.14);
    background:#fff;
    text-align:left;
  }
  .pickup-field{
    display:flex;
    flex-direction:column;
    gap:6px;
    font-size:13px;
  }
  .pickup-field-row{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
  }
  .pickup-current{
    margin-top:6px;
    opacity:.8;
    font-size:14px;
  }
  .pickup-wolt-notice{
    font-size:12px;
    color:#92400e;
    background:rgba(251,191,36,.18);
    border-radius:10px;
    padding:8px 10px;
  }
  [hidden] { display: none !important; }
</style>

<script src="{{ 'itella-pickup.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "Pickup selector",
  "target": "section",
  "settings": [
    {
      "type": "paragraph",
      "content": "Config is loaded via App Proxy at /apps/checkout/pickup-config."
    }
  ]
}
{% endschema %}
